<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/celestial/index.js - kollavarsham</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/yui/3.9.1/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <!--<link rel="shortcut icon" type="image/png" href="../assets/favicon.png">-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/yui/3.9.1/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="/kollavarsham-js/"><img src="../assets/img/logo.png" title="kollavarsham"></a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>കൊല്ലവർഷം - JavaScript API (v1.3.14)</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/BaseDate.html">BaseDate</a></li>
                                <li><a href="../classes/Calculations.html">Calculations</a></li>
                                <li><a href="../classes/Calendar.html">Calendar</a></li>
                                <li><a href="../classes/Candrocca.html">Candrocca</a></li>
                                <li><a href="../classes/Celestial.html">Celestial</a></li>
                                <li><a href="../classes/JulianDate.html">JulianDate</a></li>
                                <li><a href="../classes/Jupiter.html">Jupiter</a></li>
                                <li><a href="../classes/Kollavarsham.html">Kollavarsham</a></li>
                                <li><a href="../classes/KollavarshamDate.html">KollavarshamDate</a></li>
                                <li><a href="../classes/Mars.html">Mars</a></li>
                                <li><a href="../classes/MathHelper.html">MathHelper</a></li>
                                <li><a href="../classes/Mercury.html">Mercury</a></li>
                                <li><a href="../classes/Moon.html">Moon</a></li>
                                <li><a href="../classes/Planet.html">Planet</a></li>
                                <li><a href="../classes/PlanetarySystem.html">PlanetarySystem</a></li>
                                <li><a href="../classes/Rahu.html">Rahu</a></li>
                                <li><a href="../classes/SakaDate.html">SakaDate</a></li>
                                <li><a href="../classes/Saturn.html">Saturn</a></li>
                                <li><a href="../classes/Star.html">Star</a></li>
                                <li><a href="../classes/Sun.html">Sun</a></li>
                                <li><a href="../classes/Venus.html">Venus</a></li>
                                <li><a href="../classes/Yuga.html">Yuga</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/baseDate.html">baseDate</a></li>
                                <li><a href="../modules/calculations.html">calculations</a></li>
                                <li><a href="../modules/calendar.html">calendar</a></li>
                                <li><a href="../modules/celestial.html">celestial</a></li>
                                <li><a href="../modules/julianDate.html">julianDate</a></li>
                                <li><a href="../modules/kollavarsham.html">kollavarsham</a></li>
                                <li><a href="../modules/kollavarshamDate.html">kollavarshamDate</a></li>
                                <li><a href="../modules/mathHelper.html">mathHelper</a></li>
                                <li><a href="../modules/planetarySystem.html">planetarySystem</a></li>
                                <li><a href="../modules/planets.html">planets</a></li>
                                <li><a href="../modules/sakaDate.html">sakaDate</a></li>
                                <li><a href="../modules/yuga.html">yuga</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content"><h1 class="file-heading">File: lib/celestial/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * kollavarsham
 * http://kollavarsham.org
 *
 * Copyright (c) 2014-2018 The Kollavarsham Team
 * Licensed under the MIT license.
 */

/**
 * @module celestial
 */
import MathHelper from &#x27;./../mathHelper.js&#x27;;
import PlanetarySystem from &#x27;./planetarySystem/index.js&#x27;;

/**
 *
 *  **INTERNAL/PRIVATE**
 *
 * @class Celestial
 */
class Celestial {

  constructor(system = &#x27;SuryaSiddhanta&#x27;) {
    let planetarySystem = new PlanetarySystem(system);
    this.planets = planetarySystem.planets;
    this.yuga = planetarySystem.yuga;

    this.backLastConjunctionAhargana = -1;
    this.backNextConjunctionAhargana = -1;
    this.backLastConjunctionLongitude = -1;
    this.backNextConjunctionLongitude = -1;
  }

  static threeRelation(left, center, right) {
    if (left &lt; center &amp;&amp; center &lt; right) {
      return 1;
    } else if (right &lt; center &amp;&amp; center &lt; left) {
      return -1;
    }
    return 0;
  }

  static declination(longitude) {
    // https://en.wikipedia.org/wiki/Declination
    return Math.asin(Math.sin(longitude / MathHelper.radianInDegrees) * Math.sin(24 / MathHelper.radianInDegrees)) *
      MathHelper.radianInDegrees;
  }

  static getSunriseTime(time, equationOfTime) {
    // TODO: Add Tests if/when feasible
    const sunriseTime = (time - equationOfTime) * 24;
    const sunriseHour = MathHelper.truncate(sunriseTime);
    const sunriseMinute = MathHelper.truncate(60 * MathHelper.fractional(sunriseTime));
    return {sunriseHour, sunriseMinute};
  }

  static getTithi(trueSolarLongitude, trueLunarLongitude) {
    let eclipticLongitude = trueLunarLongitude - trueSolarLongitude;
    eclipticLongitude = MathHelper.zero360(eclipticLongitude);

    return eclipticLongitude / 12;
  }

  setPlanetaryPositions(ahargana) {
    const $planets = this.planets;

    // Lunar apogee and node at sunrise
    $planets.candrocca.MeanPosition = MathHelper.zero360(this.getMeanLongitude(ahargana, $planets.candrocca.YugaRotation) + 90);
    $planets.rahu.MeanPosition = MathHelper.zero360(this.getMeanLongitude(ahargana, $planets.rahu.YugaRotation) + 180);

    // mean and true sun at sunrise
    const meanSolarLongitude = this.getMeanLongitude(ahargana, $planets.sun.YugaRotation);
    $planets.sun.MeanPosition = meanSolarLongitude;

    const trueSolarLongitude = MathHelper.zero360(meanSolarLongitude - this.getMandaEquation(meanSolarLongitude - $planets.sun.Apogee, &#x27;sun&#x27;));

    // mean and true moon at sunrise
    const meanLunarLongitude = this.getMeanLongitude(ahargana, $planets.moon.YugaRotation);
    $planets.moon.MeanPosition = meanLunarLongitude;

    $planets.moon.Apogee = $planets.candrocca.MeanPosition;

    const trueLunarLongitude = MathHelper.zero360(meanLunarLongitude - this.getMandaEquation(meanLunarLongitude - $planets.moon.Apogee, &#x27;moon&#x27;));

    // The below was a separate method named calculations.planetary (ported from planetary_calculations in perl)
    const planetNames = [&#x27;mercury&#x27;, &#x27;venus&#x27;, &#x27;mars&#x27;, &#x27;jupiter&#x27;, &#x27;saturn&#x27;];
    for (let i = 0; i &lt; planetNames.length; i++) {
      $planets[planetNames[i]].MeanPosition = this.getMeanLongitude(ahargana, $planets[planetNames[i]].Rotation);
    }
    return {trueSolarLongitude, trueLunarLongitude};
  }

  getMeanLongitude(ahargana, rotation) {
    // https://en.wikipedia.org/wiki/Mean_longitude
    // https://en.wikipedia.org/wiki/Ecliptic_coordinate_system#Spherical_coordinates
    return 360 * MathHelper.fractional(rotation * ahargana / this.yuga.CivilDays);
  }

  getDaylightEquation(year, latitude, ahargana) {
    // Good read - http://en.wikipedia.org/wiki/Equation_of_time#Calculating_the_equation_of_time
    const meanSolarLongitude = this.getMeanLongitude(ahargana, this.planets.sun.YugaRotation);

    // Sayana Solar Longitude and Declination
    const sayanaMeanSolarLongitude = meanSolarLongitude + 54 / 3600 * (year - 499);
    const sayanaDeclination = Celestial.declination(sayanaMeanSolarLongitude); // See Sewell, p.10

    // Equation of day light by Analemma (https://en.wikipedia.org/wiki/Analemma)
    const x = Math.tan(latitude / MathHelper.radianInDegrees) * Math.tan(sayanaDeclination / MathHelper.radianInDegrees);

    return 0.5 * Math.asin(x) / Math.PI;
  }

  getMandaEquation(argument, planet) {
    return Math.asin(this.planets[planet].MandaCircumference / 360 * Math.sin(argument / MathHelper.radianInDegrees)) * MathHelper.radianInDegrees;
  }

  getTrueLunarLongitude(ahargana) {
    const meanLunarLongitude = this.getMeanLongitude(ahargana, this.planets.moon.YugaRotation);
    const apogee = this.getMeanLongitude(ahargana, this.planets.candrocca.YugaRotation) + 90;
    return MathHelper.zero360(meanLunarLongitude - this.getMandaEquation(meanLunarLongitude - apogee, &#x27;moon&#x27;));
  }

  getTrueSolarLongitude(ahargana) {
    const meanSolarLongitude = this.getMeanLongitude(ahargana, this.planets.sun.YugaRotation);
    return MathHelper.zero360(meanSolarLongitude - this.getMandaEquation(meanSolarLongitude - this.planets.sun.Apogee, &#x27;sun&#x27;));
  }

  getEclipticLongitude(ahargana) {
    let eclipticLongitude = Math.abs(this.getTrueLunarLongitude(ahargana) - this.getTrueSolarLongitude(ahargana));
    if (eclipticLongitude &gt;= 180) {
      eclipticLongitude = 360 - eclipticLongitude;
    }
    return eclipticLongitude;
  }

  findConjunction(leftX, leftY, rightX, rightY) {
    const width = (rightX - leftX) / 2;
    const centreX = (rightX + leftX) / 2;
    if (width &lt; MathHelper.epsilon) {
      return this.getTrueSolarLongitude(centreX);
    } else {
      const centreY = this.getEclipticLongitude(centreX);
      const relation = Celestial.threeRelation(leftY, centreY, rightY);
      if (relation &lt; 0) {
        rightX += width;
        rightY = this.getEclipticLongitude(rightX);
        return this.findConjunction(centreX, centreY, rightX, rightY);
      } else if (relation &gt; 0) {
        leftX -= width;
        leftY = this.getEclipticLongitude(leftX);
        return this.findConjunction(leftX, leftY, centreX, centreY);
      } else {
        leftX += width / 2;
        leftY = this.getEclipticLongitude(leftX);
        rightX -= width / 2;
        rightY = this.getEclipticLongitude(rightX);
        return this.findConjunction(leftX, leftY, rightX, rightY);
      }
    }
  }

  getConjunction(ahargana) {
    const leftX = ahargana - 2;
    const leftY = this.getEclipticLongitude(leftX);
    const rightX = ahargana + 2;
    const rightY = this.getEclipticLongitude(rightX);
    return this.findConjunction(leftX, leftY, rightX, rightY);
  }

  getLastConjunctionLongitude(ahargana, tithi) {
    const newNew = this.yuga.CivilDays / (this.planets.moon.YugaRotation - this.planets.sun.YugaRotation);
    ahargana -= tithi * (newNew / 30);

    if (Math.abs(ahargana - this.backLastConjunctionAhargana) &lt; 1) {
      return this.backLastConjunctionLongitude;
    } else if (Math.abs(ahargana - this.backNextConjunctionAhargana) &lt; 1) {
      this.backLastConjunctionAhargana = this.backNextConjunctionAhargana;
      this.backLastConjunctionLongitude = this.backNextConjunctionLongitude;
      return this.backNextConjunctionLongitude;
    } else {
      this.backLastConjunctionAhargana = ahargana;
      this.backLastConjunctionLongitude = this.getConjunction(ahargana);
      return this.backLastConjunctionLongitude;
    }
  }

  getNextConjunctionLongitude(ahargana, tithi) {
    const newNew = this.yuga.CivilDays / (this.planets.moon.YugaRotation - this.planets.sun.YugaRotation);
    ahargana += (30 - tithi) * (newNew / 30);

    if (Math.abs(ahargana - this.backNextConjunctionAhargana) &lt; 1) {
      return this.backNextConjunctionLongitude;
    } else {
      this.backNextConjunctionAhargana = ahargana;
      this.backNextConjunctionLongitude = this.getConjunction(ahargana);
      return this.backNextConjunctionLongitude;
    }
  }

}

export default Celestial;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<footer id="footer">
  <span class="copyright"><a href="/LICENSE.txt">&copy; 2014-2019 The Kollavarsham Team</a></span>
  <a href="/" id="footer-back"><span>Back to kollavarsham.org</span></a>
  <span class="last-modified">Last Updated: Sat, 16 Nov 2019 18:47:26 GMT</span>
</footer>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4869398-6', 'kollavarsham.org');
  ga('send', 'pageview');

</script>
</body>
</html>

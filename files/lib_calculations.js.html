<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/calculations.js - kollavarsham</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/yui/3.9.1/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <!--<link rel="shortcut icon" type="image/png" href="../assets/favicon.png">-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/yui/3.9.1/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="/kollavarsham-js/"><img src="../assets/img/logo.png" title="kollavarsham"></a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>കൊല്ലവർഷം - JavaScript API (v1.3.12)</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/BaseDate.html">BaseDate</a></li>
                                <li><a href="../classes/Calculations.html">Calculations</a></li>
                                <li><a href="../classes/Calendar.html">Calendar</a></li>
                                <li><a href="../classes/Candrocca.html">Candrocca</a></li>
                                <li><a href="../classes/Celestial.html">Celestial</a></li>
                                <li><a href="../classes/JulianDate.html">JulianDate</a></li>
                                <li><a href="../classes/Jupiter.html">Jupiter</a></li>
                                <li><a href="../classes/Kollavarsham.html">Kollavarsham</a></li>
                                <li><a href="../classes/KollavarshamDate.html">KollavarshamDate</a></li>
                                <li><a href="../classes/Mars.html">Mars</a></li>
                                <li><a href="../classes/MathHelper.html">MathHelper</a></li>
                                <li><a href="../classes/Mercury.html">Mercury</a></li>
                                <li><a href="../classes/Moon.html">Moon</a></li>
                                <li><a href="../classes/Planet.html">Planet</a></li>
                                <li><a href="../classes/PlanetarySystem.html">PlanetarySystem</a></li>
                                <li><a href="../classes/Rahu.html">Rahu</a></li>
                                <li><a href="../classes/SakaDate.html">SakaDate</a></li>
                                <li><a href="../classes/Saturn.html">Saturn</a></li>
                                <li><a href="../classes/Star.html">Star</a></li>
                                <li><a href="../classes/Sun.html">Sun</a></li>
                                <li><a href="../classes/Venus.html">Venus</a></li>
                                <li><a href="../classes/Yuga.html">Yuga</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/baseDate.html">baseDate</a></li>
                                <li><a href="../modules/calculations.html">calculations</a></li>
                                <li><a href="../modules/calendar.html">calendar</a></li>
                                <li><a href="../modules/celestial.html">celestial</a></li>
                                <li><a href="../modules/julianDate.html">julianDate</a></li>
                                <li><a href="../modules/kollavarsham.html">kollavarsham</a></li>
                                <li><a href="../modules/kollavarshamDate.html">kollavarshamDate</a></li>
                                <li><a href="../modules/mathHelper.html">mathHelper</a></li>
                                <li><a href="../modules/planetarySystem.html">planetarySystem</a></li>
                                <li><a href="../modules/planets.html">planets</a></li>
                                <li><a href="../modules/sakaDate.html">sakaDate</a></li>
                                <li><a href="../modules/yuga.html">yuga</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content"><h1 class="file-heading">File: lib/calculations.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * kollavarsham
 * http://kollavarsham.org
 *
 * Copyright (c) 2014-2018 The Kollavarsham Team
 * Licensed under the MIT license.
 */

/**
 * @module calculations
 */
import Calendar from &#x27;./calendar.js&#x27;;
import Celestial from &#x27;./celestial/index.js&#x27;;
import JulianDate from &#x27;./dates/julianDate.js&#x27;;
import KollavarshamDate from &#x27;./dates/kollavarshamDate.js&#x27;;
import MathHelper from &#x27;./mathHelper.js&#x27;;
import SakaDate from &#x27;./dates/sakaDate.js&#x27;;

const Ujjain = {
  latitude  : 23.2,
  longitude : 75.8
};

/**
 *
 *  **INTERNAL/PRIVATE**
 *
 * @class Calculations
 */
class Calculations {

  constructor(settings) {
    this.longitude = settings.longitude;
    this.latitude = settings.latitude;
    this.celestial = new Celestial(settings.system);
    this.calendar = new Calendar(this.celestial);
  }

  static getPaksa(tithi) {
    return tithi &gt;= 15 ? &#x27;Krsnapaksa&#x27; : &#x27;Suklapaksa&#x27;;
  }

  fromGregorianToSaka(gregorianDate) {
    const year = gregorianDate.getFullYear();

    let julianDay = Calendar.gregorianDateToJulianDay(gregorianDate);
    let ahargana = Calendar.julianDayToAhargana(julianDay);

    // Calculate the SakaDate at 6 AM
    const timeAsFractionalDayAt6AM = 0.25; // time at 6 o&#x27;clock
    const sakaDate = this.celestialCalculations(ahargana, year, julianDay, timeAsFractionalDayAt6AM);

    // Calculate the SakaDate at the given time
    // (this is done only for the resulting the naksatra, which now has better precision)
    const timeFromGregorianDate = Calendar.timeIntoFractionalDay(gregorianDate);
    const sakaDateAtGivenTime = this.celestialCalculations(ahargana, year, julianDay, timeFromGregorianDate);
    sakaDate.naksatra = sakaDateAtGivenTime.naksatra;

    sakaDate.gregorianDate = gregorianDate; // set the input gregorian date
    return sakaDate;
  }

  celestialCalculations(ahargana, year, julianDay, timeAsFractionalDay) {
    ahargana += timeAsFractionalDay;

    // Definition of desantara
    //      http://books.google.com/books?id=kt9DIY1g9HYC&amp;pg=PA683&amp;lpg=PA683&amp;dq=desantara&amp;source=bl&amp;ots=NLd1wFKFfN&amp;sig=jCfG95R-6eiSff3L73DCodijo1I&amp;hl=en&amp;sa=X&amp;ei=uKgHU__uKOr7yAGm0YGoBQ&amp;ved=0CF8Q6AEwCDgK#v=onepage&amp;q=desantara&amp;f=false
    const desantara = (this.longitude - Ujjain.longitude) / 360;

    // desantara
    ahargana -= desantara;

    // time of sunrise at local latitude
    const equationOfTime = this.celestial.getDaylightEquation(year, this.latitude, ahargana);
    ahargana -= equationOfTime;
    const {sunriseHour, sunriseMinute} = Celestial.getSunriseTime(timeAsFractionalDay, equationOfTime);

    const {trueSolarLongitude, trueLunarLongitude} = this.celestial.setPlanetaryPositions(ahargana);

    // finding tithi and longitude of conjunction
    const tithi = Celestial.getTithi(trueSolarLongitude, trueLunarLongitude);

    // last conjunction &amp; next conjunction
    const lastConjunctionLongitude = this.celestial.getLastConjunctionLongitude(ahargana, tithi);
    const nextConjunctionLongitude = this.celestial.getNextConjunctionLongitude(ahargana, tithi);

    const masaNum = Calendar.getMasaNum(trueSolarLongitude, lastConjunctionLongitude);

    // kali and Saka era
    const kaliYear = this.calendar.aharganaToKali(ahargana + ( 4 - masaNum ) * 30);
    const sakaYear = Calendar.kaliToSaka(kaliYear);

    let tithiDay = MathHelper.truncate(tithi) + 1;

    const paksa = Calculations.getPaksa(tithiDay);
    tithiDay = tithiDay &gt;= 15 ? tithiDay -= 15 : tithiDay;

    const {sauraMasa, sauraDivasa} = this.calendar.getSauraMasaAndSauraDivasa(ahargana, desantara);

    const sakaDate = new SakaDate(sakaYear, masaNum, tithiDay, paksa);

    sakaDate.julianDay = MathHelper.truncate(julianDay + 0.5);
    sakaDate.ahargana = MathHelper.truncate(ahargana + 0.5); // Remove the decimals
    sakaDate.originalAhargana = ahargana;
    sakaDate.sauraMasa = sauraMasa;
    sakaDate.sauraDivasa = sauraDivasa;
    sakaDate.naksatra = Calendar.getNaksatra(trueLunarLongitude);
    sakaDate.kaliYear = kaliYear;
    sakaDate.adhimasa = Calendar.getAdhimasa(lastConjunctionLongitude, nextConjunctionLongitude);
    sakaDate.fractionalTithi = MathHelper.fractional(tithi);
    sakaDate.sunriseHour = sunriseHour;
    sakaDate.sunriseMinute = sunriseMinute;
    return sakaDate;
  }

  fromGregorian(gregorianDate) {

    const sakaDate = this.fromGregorianToSaka(gregorianDate);

    return sakaDate.generateKollavarshamDate();

  }

  toGregorian(kollavarshamDate) {
    // TODO: Implement this to convert a Kollavarsham date to Gregorian
    console.log(&#x27;kollavarshamDate: &#x27; + JSON.stringify(kollavarshamDate)); // eslint-disable-line no-console
    throw new Error(&#x27;Not implemented&#x27;);
  }

  toGregorianFromSaka(sakaDate) {
    // TODO: Remove this method??
    // This is implemented specifically for the pancanga-nodejs cli (https://github.com/kollavarsham/pancanga-nodejs)
    // Could be removed when toGregorian has been implemented based on this

    const sakaYear = sakaDate.year;
    const masaNum = sakaDate.month;
    let tithiDay = sakaDate.tithi;
    const paksa = sakaDate.paksa;

    if (paksa === &#x27;Krsnapaksa&#x27;) {
      tithiDay += 15;
    }
    const kaliYear = Calendar.sakaToKali(sakaYear);
    const ahargana = this.calendar.kaliToAhargana(kaliYear, masaNum, tithiDay);

    let julianDay = Calendar.aharganaToJulianDay(ahargana);
    julianDay += 0.5;

    const modernDate = Calendar.julianDayToModernDate(julianDay);
    if (JulianDate.prototype.isPrototypeOf(modernDate)) { // eslint-disable-line no-prototype-builtins
      console.log(&#x27;\nkollavarsham::toGregorianDate: *** Returning an instance of JulianDate class ***&#x27;); // eslint-disable-line no-console
    }

    // TODO: Not happy that the empty constructor will make this with MalayalamYear =&gt; 1, MalayalamMonth =&gt; 1, and MalayalamDate =&gt; 1
    // TODO: Think this through before implementing toGregorian above
    const kollavarshamDate = new KollavarshamDate();
    kollavarshamDate.gregorianDate = modernDate;
    kollavarshamDate.julianDay = julianDay;
    kollavarshamDate.ahargana = ahargana;
    kollavarshamDate.sakaDate = sakaDate;

    return kollavarshamDate;
  }

}

export default Calculations;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<footer id="footer">
  <span class="copyright"><a href="/LICENSE.txt">&copy; 2014-2019 The Kollavarsham Team</a></span>
  <a href="/" id="footer-back"><span>Back to kollavarsham.org</span></a>
  <span class="last-modified">Last Updated: Thu, 11 Jul 2019 18:52:50 GMT</span>
</footer>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4869398-6', 'kollavarsham.org');
  ga('send', 'pageview');

</script>
</body>
</html>
